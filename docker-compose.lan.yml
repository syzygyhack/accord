# LAN deployment — serves accord to other machines on your local network.
#
# Unlike docker-compose.yml (dev), this config:
#   - Uses HTTPS with self-signed certs (required for browser voice/mic)
#   - Exposes Caddy (443/80) + LiveKit media ports (7881 TCP, UDP range)
#   - Requires LAN_IP in .env (your machine's LAN address, e.g. 192.168.1.100)
#   - Routes LiveKit signaling through Caddy for TLS
#   - Binds Ergo and accord-files to localhost only (not reachable directly)
#
# TLS setup:
#   Caddy generates a self-signed root CA on first run (persisted in caddy-data).
#   - Browsers: accept the cert warning on first visit to https://<LAN_IP>.
#   - Tauri/desktop: install the CA cert so WebView2 trusts the connection:
#       docker compose -f docker-compose.lan.yml cp caddy:/data/caddy/pki/authorities/local/root.crt ./accord-ca.crt
#     Then import accord-ca.crt into your OS trust store:
#       Windows: certutil -addstore Root accord-ca.crt
#       macOS:   sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain accord-ca.crt
#       Linux:   sudo cp accord-ca.crt /usr/local/share/ca-certificates/ && sudo update-ca-certificates
#
# Firewall: ensure TCP 443, TCP 7881, and UDP 50060-50160 are open on the host.
#
# Usage:
#   docker compose -f docker-compose.lan.yml up -d

services:
  ergo:
    image: ghcr.io/ergochat/ergo:stable
    ports:
      - "127.0.0.1:6667:6667"   # IRC plaintext — localhost only
      - "127.0.0.1:8097:8097"   # WebSocket — localhost only (Caddy proxies /ws)
    environment:
      ERGO__DATASTORE__MYSQL__USER: ergo
      ERGO__DATASTORE__MYSQL__PASSWORD: ${MYSQL_ERGO_PASSWORD:-${MYSQL_ROOT_PASSWORD:?set MYSQL_ROOT_PASSWORD}}
      ERGO__API__BEARER_TOKENS: '["${ERGO_API_TOKEN:?set ERGO_API_TOKEN}"]'
      ERGO__SERVER__WEBSOCKETS__ALLOWED_ORIGINS: '[]'
    volumes:
      - ./config/ergo/ircd.yaml:/ircd/ircd.yaml
      - ergo-data:/ircd/db
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 6667 && nc -z localhost 8097 || exit 1"]
      interval: 5s
      timeout: 3s
      start_period: 5s
      retries: 3
    restart: unless-stopped

  mysql:
    image: mariadb:11
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:?set MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ergo_history
      MYSQL_USER: ergo
      MYSQL_PASSWORD: ${MYSQL_ERGO_PASSWORD:-${MYSQL_ROOT_PASSWORD:?set MYSQL_ROOT_PASSWORD}}
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 3s
      start_period: 30s
      retries: 5
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:v1.9.11
    ports:
      # Signaling (7880) NOT exposed — routed through Caddy at /livekit for TLS.
      # Media ports must be exposed directly (WebRTC UDP/TCP bypasses the proxy).
      - "7881:7881"
      - "50060-50160:50060-50160/udp"
    environment:
      LIVEKIT_CONFIG: |
        port: 7880
        rtc:
          tcp_port: 7881
          port_range_start: 50060
          port_range_end: 50160
          use_external_ip: false
          node_ip: ${LAN_IP:?set LAN_IP in .env}
        keys:
          ${LIVEKIT_API_KEY:?set LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET:?set LIVEKIT_API_SECRET}
        logging:
          level: info
        room:
          empty_timeout: 300
          max_participants: 50
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:7880 || exit 1"]
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 3
    restart: unless-stopped

  accord-files:
    build: ./accord-files
    ports:
      - "127.0.0.1:8080:8080"   # API — localhost only (Caddy proxies /api)
    environment:
      ERGO_API: http://ergo:8089
      ERGO_API_TOKEN: ${ERGO_API_TOKEN:?set ERGO_API_TOKEN}
      # Client-facing LiveKit URL routes through Caddy for TLS
      LIVEKIT_CLIENT_URL: wss://${LAN_IP:?set LAN_IP in .env}/livekit/
      LIVEKIT_API_URL: http://livekit:7880
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY:?set LIVEKIT_API_KEY}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET:?set LIVEKIT_API_SECRET}
      JWT_SECRET: ${JWT_SECRET:?set JWT_SECRET}
      SERVER_NAME: ${SERVER_NAME:-}
      SERVER_ID: ${SERVER_ID:-}
      BASE_URL: https://${LAN_IP:?set LAN_IP in .env}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-}
    volumes:
      - ./config/accord/accord.json:/app/config/accord.json:ro
      - accord-uploads:/app/uploads
      - accord-data:/app/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 3
    depends_on:
      ergo:
        condition: service_healthy
      mysql:
        condition: service_healthy
    restart: unless-stopped

  caddy:
    image: caddy:2
    ports:
      - "443:443"
      - "80:80"
    environment:
      # Bare IP as SITE_ADDRESS triggers Caddy auto-HTTPS with self-signed certs
      SITE_ADDRESS: ${LAN_IP:?set LAN_IP in .env}
    volumes:
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./accord-client/build:/srv/accord
      - caddy-data:/data
      - caddy-config:/config
    healthcheck:
      test: ["CMD-SHELL", "wget --no-check-certificate -qO- https://localhost/caddy-health || wget -qO- http://localhost/caddy-health || exit 1"]
      interval: 5s
      timeout: 3s
      start_period: 5s
      retries: 3
    depends_on:
      ergo:
        condition: service_healthy
      accord-files:
        condition: service_healthy
    restart: unless-stopped

volumes:
  ergo-data:
  mysql-data:
  accord-uploads:
  accord-data:
  caddy-data:
  caddy-config:
